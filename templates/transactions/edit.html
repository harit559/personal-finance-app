{% extends 'base.html' %}

{% block title %}Edit Transaction - Harit Finance{% endblock %}

{% block content %}
<div class="max-w-xl mx-auto">
    <h1 class="text-2xl font-bold mb-6">Edit Transaction</h1>
    
    <form method="POST" class="bg-slate-800 rounded-xl border border-slate-700 p-6 space-y-6">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
        <!-- Transaction Type -->
        <div>
            <label class="block text-sm text-slate-400 mb-2">Type</label>
            <div class="flex gap-4">
                <label class="flex items-center gap-2 cursor-pointer">
                    <input type="radio" name="type" value="expense" 
                           {% if transaction.amount < 0 %}checked{% endif %}
                           class="text-indigo-600 focus:ring-indigo-500">
                    <span class="text-red-400">ðŸ’¸ Expense</span>
                </label>
                <label class="flex items-center gap-2 cursor-pointer">
                    <input type="radio" name="type" value="income"
                           {% if transaction.amount >= 0 %}checked{% endif %}
                           class="text-indigo-600 focus:ring-indigo-500">
                    <span class="text-green-400">ðŸ’° Income</span>
                </label>
            </div>
        </div>
        
        <!-- Account -->
        <div>
            <label for="account_id" class="block text-sm text-slate-400 mb-2">Account</label>
            <select name="account_id" 
                    id="account_id"
                    required
                    class="w-full bg-slate-700 border border-slate-600 rounded-lg px-4 py-3 text-white focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500">
                {% for account in accounts %}
                <option value="{{ account.id }}" 
                        data-currency="{{ account.currency|currency_symbol }}"
                        {% if transaction.account_id == account.id %}selected{% endif %}>
                    {{ account.name }} ({{ account.currency|currency_symbol }}{{ "%.2f"|format(account.balance) }})
                </option>
                {% endfor %}
            </select>
        </div>
        
        <!-- Amount -->
        <div>
            <label for="amount" class="block text-sm text-slate-400 mb-2">Amount</label>
            <div class="relative">
                <span class="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400" id="currency-symbol">{{ transaction.account.currency|currency_symbol }}</span>
                <input type="number" 
                       name="amount" 
                       id="amount"
                       step="0.01" 
                       min="0.01"
                       value="{{ transaction.amount|abs }}"
                       required
                       class="w-full bg-slate-700 border border-slate-600 rounded-lg pl-8 pr-4 py-3 text-white focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500">
            </div>
        </div>
        
        <!-- Category -->
        <div>
            <label for="category_id" class="block text-sm text-slate-400 mb-2">Category</label>
            <select name="category_id" 
                    id="category_id"
                    class="w-full bg-slate-700 border border-slate-600 rounded-lg px-4 py-3 text-white focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500">
                <option value="">No category</option>
                {% for cat in categories if cat.category_type == 'expense' %}
                <option value="{{ cat.id }}" 
                        data-type="expense"
                        {% if transaction.category_id == cat.id %}selected{% endif %}>
                    {{ cat.icon }} {{ cat.name }}
                </option>
                {% endfor %}
                {% for cat in categories if cat.category_type == 'income' %}
                <option value="{{ cat.id }}" 
                        data-type="income"
                        {% if transaction.category_id == cat.id %}selected{% endif %}>
                    {{ cat.icon }} {{ cat.name }}
                </option>
                {% endfor %}
            </select>
        </div>
        
        <!-- Date -->
        <div>
            <label for="date" class="block text-sm text-slate-400 mb-2">Date</label>
            <input type="date" 
                   name="date" 
                   id="date"
                   value="{{ transaction.date.strftime('%Y-%m-%d') }}"
                   required
                   class="w-full bg-slate-700 border border-slate-600 rounded-lg px-4 py-3 text-white focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500">
        </div>
        
        <!-- Description -->
        <div>
            <label for="description" class="block text-sm text-slate-400 mb-2">Description (optional)</label>
            <input type="text" 
                   name="description" 
                   id="description"
                   value="{{ transaction.description or '' }}"
                   placeholder="What was this for?"
                   class="w-full bg-slate-700 border border-slate-600 rounded-lg px-4 py-3 text-white placeholder-slate-500 focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500">
        </div>
        
        <!-- Location -->
        <div>
            <label for="location" class="block text-sm text-slate-400 mb-2">Location (optional)</label>
            <input type="text" 
                   name="location" 
                   id="location"
                   value="{{ transaction.location or '' }}"
                   placeholder="Where did you spend?"
                   class="w-full bg-slate-700 border border-slate-600 rounded-lg px-4 py-3 text-white placeholder-slate-500 focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500">
        </div>
        
        <!-- Buttons -->
        <div class="flex gap-4 pt-4">
            <button type="submit" 
                    class="flex-1 bg-indigo-600 hover:bg-indigo-700 text-white py-3 rounded-lg font-medium transition">
                Save Changes
            </button>
            <a href="{{ url_for('transactions.list_transactions') }}" 
               class="px-6 py-3 border border-slate-600 rounded-lg text-slate-300 hover:bg-slate-700 transition">
                Cancel
            </a>
        </div>
    </form>
</div>

<script>
    // Update currency symbol when account changes
    document.getElementById('account_id').addEventListener('change', function() {
        const selectedOption = this.options[this.selectedIndex];
        const currency = selectedOption.getAttribute('data-currency') || '$';
        document.getElementById('currency-symbol').textContent = currency;
    });

    // Filter categories based on transaction type
    const typeRadios = document.querySelectorAll('input[name="type"]');
    const categorySelect = document.getElementById('category_id');
    const allCategoryOptions = Array.from(categorySelect.options);
    
    // Store the currently selected category
    let currentlySelectedCategory = categorySelect.value;

    function filterCategories() {
        const selectedType = document.querySelector('input[name="type"]:checked').value;
        
        // Store current selection if it exists
        currentlySelectedCategory = categorySelect.value;
        
        // Remove all options except "No category"
        categorySelect.innerHTML = '<option value="">No category</option>';
        
        // Add back only matching categories
        allCategoryOptions.forEach(option => {
            if (option.value === '') return; // Skip the "No category" option
            
            const categoryType = option.getAttribute('data-type');
            if (categoryType === selectedType) {
                const newOption = option.cloneNode(true);
                // Restore selection if it matches the type
                if (option.value === currentlySelectedCategory) {
                    newOption.selected = true;
                }
                categorySelect.appendChild(newOption);
            }
        });
    }

    // Add event listener to type radio buttons
    typeRadios.forEach(radio => {
        radio.addEventListener('change', filterCategories);
    });

    // Filter categories on page load based on current transaction type
    filterCategories();
</script>
{% endblock %}
